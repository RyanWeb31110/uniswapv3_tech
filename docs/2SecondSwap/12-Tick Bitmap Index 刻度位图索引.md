# UniswapV3 æŠ€æœ¯å­¦ä¹ ç³»åˆ—ï¼ˆåäºŒï¼‰ï¼šTick Bitmap Index - åˆ»åº¦ä½å›¾ç´¢å¼•

## ç³»åˆ—æ–‡ç« å¯¼èˆª

æœ¬æ–‡æ˜¯ UniswapV3 æŠ€æœ¯å­¦ä¹ ç³»åˆ—çš„ç¬¬åäºŒç¯‡ï¼Œå±äº"é‡Œç¨‹ç¢‘ 2ï¼šç¬¬äºŒæ¬¡äº¤æ¢"æ¨¡å—ã€‚åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬æ·±å…¥å­¦ä¹ äº† Solidity ä¸­çš„æ•°å­¦è¿ç®—å®ç°ï¼ŒåŒ…æ‹¬å®šç‚¹æ•°è¿ç®—ã€å¹³æ–¹æ ¹è®¡ç®—å’Œè¾“å‡ºé‡‘é¢çš„ç²¾ç¡®è®¡ç®—ã€‚è¿™äº›æ•°å­¦åŸºç¡€ä¸º UniswapV3 çš„æ ¸å¿ƒåŠŸèƒ½æä¾›äº†åšå®çš„è®¡ç®—æ”¯æ’‘ã€‚

ç°åœ¨ï¼Œæˆ‘ä»¬å°†è¿›å…¥ä¸€ä¸ªæ–°çš„é‡è¦é˜¶æ®µï¼šå®ç° Tick Bitmap Indexï¼ˆåˆ»åº¦ä½å›¾ç´¢å¼•ï¼‰ã€‚ä½œä¸ºå®ç°åŠ¨æ€swapçš„ç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬éœ€è¦å»ºç«‹ä¸€ä¸ªé«˜æ•ˆçš„åˆ»åº¦ç´¢å¼•ç³»ç»Ÿã€‚

> **åŸæ–‡é“¾æ¥ï¼š** [Tick Bitmap Index - Uniswap V3 Development Book](https://uniswapv3book.com/milestone_2/tick-bitmap-index.html)

---

## ä¸€ã€ä»ç¡¬ç¼–ç åˆ°åŠ¨æ€æŸ¥æ‰¾ï¼šTick ç´¢å¼•çš„å¿…è¦æ€§

### 1.1 å‰æƒ…å›é¡¾

åœ¨ä¹‹å‰çš„é‡Œç¨‹ç¢‘ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ç¡¬ç¼–ç çš„æ–¹å¼è®¡ç®—ç›®æ ‡åˆ»åº¦ï¼š

```solidity
function swap(address recipient, bytes calldata data)
    public
    returns (int256 amount0, int256 amount1)
{
  int24 nextTick = 85184;  // ç¡¬ç¼–ç çš„ç›®æ ‡åˆ»åº¦
  ...
}
```

ç„¶è€Œï¼Œå½“ä¸åŒä»·æ ¼åŒºé—´éƒ½å­˜åœ¨æµåŠ¨æ€§æ—¶ï¼Œæˆ‘ä»¬æ— æ³•ç®€å•åœ°è®¡ç®—ç›®æ ‡åˆ»åº¦ï¼Œè€Œæ˜¯éœ€è¦åŠ¨æ€åœ°æ‰¾åˆ°å®ƒã€‚

### 1.2 é—®é¢˜åˆ†æ

**ç¡¬ç¼–ç æ–¹å¼çš„å±€é™æ€§ï¼š**
- âŒ åªèƒ½å¤„ç†å›ºå®šçš„ä»·æ ¼åŒºé—´
- âŒ æ— æ³•é€‚åº”åŠ¨æ€çš„æµåŠ¨æ€§åˆ†å¸ƒ
- âŒ ä¸æ”¯æŒå¤šèŒƒå›´äº¤æ¢
- âŒ ç¼ºä¹æ‰©å±•æ€§

**åŠ¨æ€æŸ¥æ‰¾çš„éœ€æ±‚ï¼š**
- âœ… æ”¯æŒä»»æ„ä»·æ ¼åŒºé—´çš„æµåŠ¨æ€§
- âœ… é€‚åº”åŠ¨æ€çš„æµåŠ¨æ€§åˆ†å¸ƒ
- âœ… æ”¯æŒå¤šèŒƒå›´äº¤æ¢
- âœ… å…·å¤‡è‰¯å¥½çš„æ‰©å±•æ€§

### 1.3 è§£å†³æ–¹æ¡ˆï¼šTick Bitmap Index

å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦**å°†æ‰€æœ‰å…·æœ‰æµåŠ¨æ€§çš„åˆ»åº¦è¿›è¡Œç´¢å¼•åŒ–**ï¼Œç„¶å**ä½¿ç”¨è¿™ä¸ªç´¢å¼•æ¥å¿«é€Ÿå®šä½èƒ½å¤Ÿä¸ºswapæä¾›è¶³å¤ŸæµåŠ¨æ€§çš„åˆ»åº¦**ã€‚æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»å¦‚ä½•å®ç°è¿™æ ·ä¸€ä¸ªé«˜æ•ˆçš„ç´¢å¼•ç³»ç»Ÿã€‚

> ğŸ¯ **æ ¸å¿ƒç›®æ ‡**
> 
> å®ç°ä¸€ä¸ªé«˜æ•ˆçš„ Tick ç´¢å¼•ç³»ç»Ÿï¼Œæ”¯æŒï¼š
> - å¿«é€ŸæŸ¥æ‰¾æœ‰æµåŠ¨æ€§çš„åˆ»åº¦
> - åŠ¨æ€æ›´æ–°åˆ»åº¦çŠ¶æ€
> - é«˜æ•ˆçš„å­˜å‚¨å’Œè®¡ç®—

## äºŒã€ä½å›¾æŠ€æœ¯æ¦‚è¿°

### 2.1 ä»€ä¹ˆæ˜¯ä½å›¾

ä½å›¾ï¼ˆBitmapï¼‰æ˜¯ä¸€ç§æµè¡Œçš„æ•°æ®ç´§å‡‘ç´¢å¼•æŠ€æœ¯ã€‚ä½å›¾æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªç”¨äºŒè¿›åˆ¶è¡¨ç¤ºçš„æ•°å­—ï¼Œä¾‹å¦‚ 31337 å¯ä»¥è¡¨ç¤ºä¸º `111101001101001`ã€‚æˆ‘ä»¬å¯ä»¥å°†å…¶è§†ä¸ºä¸€ä¸ªç”± 0 å’Œ 1 ç»„æˆçš„æ•°ç»„ï¼Œæ¯ä¸ªæ•°å­—éƒ½æœ‰ä¸€ä¸ªç´¢å¼•ä½ç½®ã€‚

- **0** è¡¨ç¤ºæ ‡å¿—æœªè®¾ç½®
- **1** è¡¨ç¤ºæ ‡å¿—å·²è®¾ç½®

è¿™æ ·æˆ‘ä»¬å°±å¾—åˆ°äº†ä¸€ä¸ªéå¸¸ç´§å‡‘çš„ç´¢å¼•æ ‡å¿—æ•°ç»„ï¼šæ¯ä¸ªå­—èŠ‚å¯ä»¥å®¹çº³ 8 ä¸ªæ ‡å¿—ã€‚åœ¨ Solidity ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æœ€å¤š 256 ä½çš„æ•´æ•°ï¼Œè¿™æ„å‘³ç€ä¸€ä¸ª `uint256` å¯ä»¥å®¹çº³ 256 ä¸ªæ ‡å¿—ã€‚

> ğŸ’¡ **ä½å›¾çš„ä¼˜åŠ¿**
> 
> 1. **ç©ºé—´æ•ˆç‡**ï¼šä¸€ä¸ª uint256 å¯ä»¥å­˜å‚¨ 256 ä¸ªå¸ƒå°”å€¼
> 2. **è®¡ç®—æ•ˆç‡**ï¼šä½è¿ç®—æ“ä½œéå¸¸å¿«é€Ÿ
> 3. **å†…å­˜å‹å¥½**ï¼šå‡å°‘å­˜å‚¨è®¿é—®æ¬¡æ•°
> 4. **Gas ä¼˜åŒ–**ï¼šé™ä½åˆçº¦æ‰§è¡Œæˆæœ¬

### 2.2 UniswapV3 ä¸­çš„ä½å›¾åº”ç”¨

UniswapV3 ä½¿ç”¨ä½å›¾æŠ€æœ¯æ¥å­˜å‚¨å·²åˆå§‹åŒ–åˆ»åº¦çš„ä¿¡æ¯ï¼Œå³å…·æœ‰ä¸€å®šæµåŠ¨æ€§çš„åˆ»åº¦ï¼š

- å½“æ ‡å¿—ä½è¢«è®¾ç½®ï¼ˆ1ï¼‰æ—¶ï¼Œè¯¥åˆ»åº¦å…·æœ‰æµåŠ¨æ€§
- å½“æ ‡å¿—ä½æœªè®¾ç½®ï¼ˆ0ï¼‰æ—¶ï¼Œè¯¥åˆ»åº¦æœªè¢«åˆå§‹åŒ–

è¿™ç§è®¾è®¡ä½¿å¾—æˆ‘ä»¬èƒ½å¤Ÿé«˜æ•ˆåœ°ç®¡ç†å’ŒæŸ¥è¯¢æµåŠ¨æ€§åˆ†å¸ƒï¼Œä¸ºåŠ¨æ€swapæä¾›åŸºç¡€æ”¯æŒã€‚

**ä½å›¾åœ¨ UniswapV3 ä¸­çš„å…·ä½“åº”ç”¨ï¼š**
- ğŸ¯ **æµåŠ¨æ€§ç´¢å¼•**ï¼šå¿«é€Ÿå®šä½æœ‰æµåŠ¨æ€§çš„ä»·æ ¼åŒºé—´
- ğŸ¯ **äº¤æ¢å¯¼èˆª**ï¼šåœ¨swapè¿‡ç¨‹ä¸­æ‰¾åˆ°ä¸‹ä¸€ä¸ªä»·æ ¼ç‚¹
- ğŸ¯ **çŠ¶æ€ç®¡ç†**ï¼šè·Ÿè¸ªåˆ»åº¦çš„åˆå§‹åŒ–çŠ¶æ€
- ğŸ¯ **æ€§èƒ½ä¼˜åŒ–**ï¼šé¿å…éå†æ‰€æœ‰åˆ»åº¦

## ä¸‰ã€TickBitmap åˆçº¦å®ç°

### 3.1 åˆçº¦ç»“æ„è®¾è®¡

åœ¨æ± åˆçº¦ä¸­ï¼Œåˆ»åº¦ç´¢å¼•å­˜å‚¨åœ¨çŠ¶æ€å˜é‡ä¸­ï¼š

```solidity
contract UniswapV3Pool {
    using TickBitmap for mapping(int16 => uint256);
    mapping(int16 => uint256) public tickBitmap;
    ...
}
```

è¿™æ˜¯ä¸€ä¸ªæ˜ å°„ç»“æ„ï¼Œå…¶ä¸­ï¼š
- **é”®ï¼ˆKeyï¼‰**: `int16` ç±»å‹ï¼Œè¡¨ç¤ºå­—ä½ç½®
- **å€¼ï¼ˆValueï¼‰**: `uint256` ç±»å‹ï¼Œè¡¨ç¤ºä¸€ä¸ªå­—ï¼ˆ256ä½ï¼‰

### 3.2 "å­—"ï¼ˆWordï¼‰çš„å«ä¹‰

**è®¡ç®—æœºç§‘å­¦ä¸­çš„"å­—"**
åœ¨è®¡ç®—æœºç§‘å­¦ä¸­ï¼Œ**"å­—"ï¼ˆWordï¼‰** æ˜¯æŒ‡è®¡ç®—æœºå¤„ç†æ•°æ®çš„åŸºæœ¬å•ä½ï¼Œé€šå¸¸è¡¨ç¤ºä¸€æ¬¡å¯ä»¥å¤„ç†çš„æœ€å¤§ä½æ•°ã€‚

**åœ¨ Tick Bitmap ä¸­çš„å…·ä½“å«ä¹‰**
åœ¨ UniswapV3 çš„ Tick Bitmap å®ç°ä¸­ï¼š
- **ä¸€ä¸ªå­— = 256 ä½**
- **æ¯ä¸ªå­—å¯ä»¥å­˜å‚¨ 256 ä¸ªåˆ»åº¦çš„çŠ¶æ€ä¿¡æ¯**
- **æ¯ä¸ªä½ä»£è¡¨ä¸€ä¸ªåˆ»åº¦çš„åˆå§‹åŒ–çŠ¶æ€**ï¼ˆ0 = æœªåˆå§‹åŒ–ï¼Œ1 = å·²åˆå§‹åŒ–ï¼‰

**ä¸ºä»€ä¹ˆé€‰æ‹© 256 ä½ï¼Ÿ**
- **uint256** æ˜¯ Solidity ä¸­æœ€å¤§çš„æ•´æ•°ç±»å‹ï¼Œæ­£å¥½æ˜¯ 256 ä½
- **256 = 2^8**ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„äºŒè¿›åˆ¶è¾¹ç•Œ
- **å­˜å‚¨æ•ˆç‡**ï¼šä¸€ä¸ªå­˜å‚¨æ§½å¯ä»¥ç®¡ç† 256 ä¸ªåˆ»åº¦
- **è®¡ç®—æ•ˆç‡**ï¼šä½è¿ç®—åœ¨ 256 ä½æ•´æ•°ä¸Šéå¸¸é«˜æ•ˆ

æƒ³è±¡ä¸€ä¸ªç”± 1 å’Œ 0 ç»„æˆçš„æ— é™è¿ç»­æ•°ç»„ï¼Œæ¯ä¸ªå…ƒç´ å¯¹åº”ä¸€ä¸ªåˆ»åº¦ã€‚ä¸ºäº†åœ¨è¿™ä¸ªæ•°ç»„ä¸­å¯¼èˆªï¼Œæˆ‘ä»¬å°†å…¶æ‹†åˆ†ä¸ºå­—ï¼šé•¿åº¦ä¸º 256 ä½çš„å­æ•°ç»„ã€‚

![Tick Bitmap ç»“æ„ç¤ºæ„å›¾](../resource/tick_bitmap.png)

*å›¾ï¼šTick Bitmap ä¸­çš„åˆ»åº¦ç´¢å¼•ç»“æ„ï¼Œå±•ç¤ºäº†å¦‚ä½•å°†æ— é™æ•°ç»„åˆ†å‰²ä¸º 256 ä½çš„å­—*

> ğŸ“Š **å­˜å‚¨æ•ˆç‡å¯¹æ¯”**
> 
> | å­˜å‚¨æ–¹å¼ | å­˜å‚¨ 256 ä¸ªå¸ƒå°”å€¼ | Gas æ¶ˆè€— |
> |---------|------------------|----------|
> | å¸ƒå°”æ•°ç»„ | 256 ä¸ªå­˜å‚¨æ§½ | ~256,000 Gas |
> | ä½å›¾ | 1 ä¸ªå­˜å‚¨æ§½ | ~20,000 Gas |
> | **æ•ˆç‡æå‡** | **256 å€** | **12.8 å€** |

### 3.3 ä½ç½®è®¡ç®—ç®—æ³•

è¦æ‰¾åˆ°åˆ»åº¦åœ¨æ•°ç»„ä¸­çš„ä½ç½®ï¼Œæˆ‘ä»¬ä½¿ç”¨ä»¥ä¸‹å‡½æ•°ï¼š

```solidity
/**
 * @notice è®¡ç®—åˆ»åº¦åœ¨ä½å›¾ä¸­çš„ä½ç½®
 * @param tick ç›®æ ‡åˆ»åº¦
 * @return wordPos å­—ä½ç½®
 * @return bitPos ä½ä½ç½®
 */
function position(int24 tick) private pure returns (int16 wordPos, uint8 bitPos) {
    wordPos = int16(tick >> 8);  // ç­‰ä»·äº tick / 256
    bitPos = uint8(uint24(tick % 256));  // ä½™æ•°éƒ¨åˆ†
}
```

**ç®—æ³•è§£æ**ï¼š

- `>> 8` ç­‰ä»·äºæ•´æ•°é™¤æ³•é™¤ä»¥ 256
- **å­—ä½ç½®**ï¼šåˆ»åº¦ç´¢å¼•é™¤ä»¥ 256 çš„æ•´æ•°éƒ¨åˆ†
- **ä½ä½ç½®**ï¼šåˆ»åº¦ç´¢å¼•é™¤ä»¥ 256 çš„ä½™æ•°éƒ¨åˆ†

> ğŸ’¡ **ä½è¿ç®—çš„ä¼˜åŠ¿**
> 
> ä½¿ç”¨ `>> 8` è€Œä¸æ˜¯ `/ 256` çš„åŸå› ï¼š
> - **æ€§èƒ½**ï¼šä½è¿ç®—æ¯”é™¤æ³•è¿ç®—å¿« 10-20 å€
> - **Gas æ•ˆç‡**ï¼šä½è¿ç®—æ¶ˆè€—æ›´å°‘çš„ Gas
> - **ç²¾åº¦**ï¼šé¿å…æµ®ç‚¹æ•°ç²¾åº¦é—®é¢˜

### 3.4 ä½ç½®è®¡ç®—ç¤ºä¾‹

è®©æˆ‘ä»¬é€šè¿‡å…·ä½“ç¤ºä¾‹æ¥ç†è§£ä½ç½®è®¡ç®—ï¼š

```python
tick = 85176
word_pos = tick >> 8  # ç­‰ä»·äº tick // 2**8
bit_pos = tick % 256
print(f"Word {word_pos}, bit {bit_pos}")
# è¾“å‡º: Word 332, bit 184
```

è¿™æ„å‘³ç€åˆ»åº¦ 85176 ä½äºï¼š
- ç¬¬ 332 ä¸ªå­—
- è¯¥å­—çš„ç¬¬ 184 ä½ï¼ˆä»å³å¼€å§‹è®¡æ•°ï¼Œä» 0 å¼€å§‹ï¼‰

é€šè¿‡ä¸Šé¢çš„ç¤ºæ„å›¾ï¼Œæˆ‘ä»¬å¯ä»¥æ¸…æ¥šåœ°çœ‹åˆ°ï¼š
- æ¯ä¸ªå­—åŒ…å« 256 ä¸ªä½
- åˆ»åº¦ 85176 ä½äºç¬¬ 332 ä¸ªå­—çš„ç¬¬ 184 ä½
- è¿™ç§ç»“æ„ä½¿å¾—æˆ‘ä»¬èƒ½å¤Ÿé«˜æ•ˆåœ°ç®¡ç†å’ŒæŸ¥è¯¢åˆ»åº¦çŠ¶æ€

**å­—çš„åˆ†å‰²é€»è¾‘**ï¼š
```
æ— é™åˆ»åº¦æ•°ç»„: ... | åˆ»åº¦0-255 | åˆ»åº¦256-511 | åˆ»åº¦512-767 | ...
                â†“         â†“         â†“
              å­—0       å­—1       å­—2
            (256ä½)   (256ä½)   (256ä½)
```

- **å­— 0**ï¼šç®¡ç†åˆ»åº¦ 0-255
- **å­— 1**ï¼šç®¡ç†åˆ»åº¦ 256-511  
- **å­— 2**ï¼šç®¡ç†åˆ»åº¦ 512-767
- ä»¥æ­¤ç±»æ¨...

> ğŸ“Š **ä½ç½®è®¡ç®—æ•ˆç‡**
> 
> | æ“ä½œ | æ—¶é—´å¤æ‚åº¦ | Gas æ¶ˆè€— |
> |------|-----------|----------|
> | å­—ä½ç½®è®¡ç®— | O(1) | ~3 Gas |
> | ä½ä½ç½®è®¡ç®— | O(1) | ~3 Gas |
> | æ€»è®¡ç®—æˆæœ¬ | O(1) | ~6 Gas |
## å››ã€æ ‡å¿—ä½ç¿»è½¬æœºåˆ¶

### 4.1 flipTick å‡½æ•°å®ç°

å½“å‘æ± å­ä¸­æ·»åŠ æµåŠ¨æ€§æ—¶ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ä½å›¾ä¸­è®¾ç½®åˆ»åº¦æ ‡å¿—ï¼šä¸€ä¸ªç”¨äºä¸‹åˆ»åº¦ï¼Œä¸€ä¸ªç”¨äºä¸Šåˆ»åº¦ã€‚è¿™é€šè¿‡ `flipTick` æ–¹æ³•å®ç°ï¼š

```solidity
/**
 * @notice ç¿»è½¬æŒ‡å®šåˆ»åº¦çš„æ ‡å¿—ä½
 * @param self ä½å›¾æ˜ å°„
 * @param tick ç›®æ ‡åˆ»åº¦
 * @param tickSpacing åˆ»åº¦é—´è·
 */
function flipTick(
    mapping(int16 => uint256) storage self,
    int24 tick,
    int24 tickSpacing
) internal {
    require(tick % tickSpacing == 0, "Tick not spaced"); // ç¡®ä¿åˆ»åº¦ç¬¦åˆé—´è·è¦æ±‚
    (int16 wordPos, uint8 bitPos) = position(tick / tickSpacing);
    uint256 mask = 1 << bitPos;
    self[wordPos] ^= mask;  // ä½¿ç”¨å¼‚æˆ–æ“ä½œç¿»è½¬æ ‡å¿—ä½
}
```

**é‡è¦è¯´æ˜**ï¼šåœ¨æœ¬ä¹¦çš„å½“å‰é˜¶æ®µï¼Œ`tickSpacing` å§‹ç»ˆä¸º 1ã€‚è¿™ä¸ªå€¼ä¼šå½±å“å“ªäº›åˆ»åº¦å¯ä»¥è¢«åˆå§‹åŒ–ï¼š
- å½“ `tickSpacing = 1` æ—¶ï¼Œæ‰€æœ‰åˆ»åº¦éƒ½å¯ä»¥ç¿»è½¬
- å½“è®¾ç½®ä¸ºå…¶ä»–å€¼æ—¶ï¼Œåªæœ‰èƒ½è¢«è¯¥å€¼æ•´é™¤çš„åˆ»åº¦æ‰å¯ä»¥ç¿»è½¬

> ğŸ’¡ **flipTick çš„è®¾è®¡åŸç†**
> 
> 1. **çŠ¶æ€ç¿»è½¬**ï¼šä»æ— æµåŠ¨æ€§åˆ°æœ‰æµåŠ¨æ€§ï¼Œæˆ–ä»æœ‰æµåŠ¨æ€§åˆ°æ— æµåŠ¨æ€§
> 2. **ä½è¿ç®—ä¼˜åŒ–**ï¼šä½¿ç”¨å¼‚æˆ–æ“ä½œå®ç°é«˜æ•ˆçš„æ ‡å¿—ä½ç¿»è½¬
> 3. **é—´è·æ§åˆ¶**ï¼šé€šè¿‡ tickSpacing æ§åˆ¶å“ªäº›åˆ»åº¦å¯ä»¥è¢«åˆå§‹åŒ–
> 4. **Gas æ•ˆç‡**ï¼šå•æ¬¡æ“ä½œå®ŒæˆçŠ¶æ€æ›´æ–°

### 3.2 æ©ç ç”Ÿæˆæœºåˆ¶

æ‰¾åˆ°å­—å’Œä½çš„ä½ç½®åï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªæ©ç ã€‚æ©ç æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œå®ƒåœ¨åˆ»åº¦å¯¹åº”çš„ä½ä½ç½®ä¸Šè®¾ç½®äº†ä¸€ä¸ª 1 æ ‡å¿—ï¼š

```python
mask = 2**bit_pos  # ç­‰ä»·äº 1 << bit_pos
print(format(mask, '#0258b'))
# è¾“å‡º: 0b0000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
#                                                                                                                                    â†‘ ç¬¬184ä½
```

### 3.3 å¼‚æˆ–æ“ä½œç¿»è½¬æ ‡å¿—

ä¸ºäº†ç¿»è½¬æ ‡å¿—ä½ï¼Œæˆ‘ä»¬é€šè¿‡æŒ‰ä½å¼‚æˆ–ï¼ˆXORï¼‰å°†æ©ç åº”ç”¨åˆ°åˆ»åº¦çš„å­—ä¸Šï¼š

**æƒ…å†µ1ï¼šå°† 1 ç¿»è½¬ä¸º 0**
```python
word = (2**256) - 1  # è®¾ç½®å­—ä¸ºå…¨1
print(format(word ^ mask, '#0258b'))
# è¾“å‡º: 0b1111111111111111111111111111111111111111111111111111111111111111111111101111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
#                                                                                                                                    â†‘ ç¬¬184ä½ç¿»è½¬ä¸º0
```

**æƒ…å†µ2ï¼šå°† 0 ç¿»è½¬ä¸º 1**
```python
word = 0  # è®¾ç½®å­—ä¸ºå…¨0
print(format(word ^ mask, '#0258b'))
# è¾“å‡º: 0b0000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
#                                                                                                                                    â†‘ ç¬¬184ä½ç¿»è½¬ä¸º1
```

**å¼‚æˆ–æ“ä½œçš„ä¼˜åŠ¿**ï¼š
- å¦‚æœåŸä½ç½®æ˜¯ 1ï¼Œå¼‚æˆ–åå˜ä¸º 0
- å¦‚æœåŸä½ç½®æ˜¯ 0ï¼Œå¼‚æˆ–åå˜ä¸º 1
- å…¶ä»–ä½ç½®ä¿æŒä¸å˜
## 4. å¯»æ‰¾ä¸‹ä¸€ä¸ªå·²åˆå§‹åŒ–åˆ»åº¦

### 4.1 åŠ¨æ€åˆ»åº¦æŸ¥æ‰¾éœ€æ±‚

ä¸‹ä¸€æ­¥æ˜¯ä½¿ç”¨ä½å›¾ç´¢å¼•æŸ¥æ‰¾å…·æœ‰æµåŠ¨æ€§çš„åˆ»åº¦ã€‚åœ¨swapè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°å½“å‰åˆ»åº¦ä¹‹å‰æˆ–ä¹‹åï¼ˆå³å·¦ä¾§æˆ–å³ä¾§ï¼‰å…·æœ‰æµåŠ¨æ€§çš„åˆ»åº¦ã€‚

åœ¨ä¹‹å‰çš„é‡Œç¨‹ç¢‘ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ç¡¬ç¼–ç çš„æ–¹å¼è®¡ç®—ç›®æ ‡åˆ»åº¦ï¼Œä½†ç°åœ¨æˆ‘ä»¬éœ€è¦ä½¿ç”¨ä½å›¾ç´¢å¼•æ¥åŠ¨æ€æŸ¥æ‰¾è¿™æ ·çš„åˆ»åº¦ã€‚è¿™é€šè¿‡ `TickBitmap.nextInitializedTickWithinOneWord` å‡½æ•°å®ç°ã€‚

### 4.2 swapæ–¹å‘ä¸åˆ»åº¦æŸ¥æ‰¾

åœ¨ `nextInitializedTickWithinOneWord` å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å®ç°ä¸¤ç§åœºæ™¯ï¼š

**åœºæ™¯1ï¼šå‡ºå”®ä»£å¸ Xï¼ˆåœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­æ˜¯ ETHï¼‰**

- åœ¨å½“å‰åˆ»åº¦çš„å­—ä¸­ï¼Œå¯»æ‰¾å½“å‰åˆ»åº¦å³ä¾§çš„ä¸‹ä¸€ä¸ªå·²åˆå§‹åŒ–åˆ»åº¦

**åœºæ™¯2ï¼šå‡ºå”®ä»£å¸ Yï¼ˆåœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­æ˜¯ USDCï¼‰**
- åœ¨ä¸‹ä¸€ä¸ªï¼ˆå½“å‰ + 1ï¼‰åˆ»åº¦çš„å­—ä¸­ï¼Œå¯»æ‰¾å½“å‰åˆ»åº¦å·¦ä¾§çš„ä¸‹ä¸€ä¸ªå·²åˆå§‹åŒ–åˆ»åº¦

è¿™å¯¹åº”äºåœ¨ä»»ä¸€æ–¹å‘è¿›è¡Œswapæ—¶çš„ä»·æ ¼å˜åŠ¨ï¼š

![find_next_tick](../resource/find_next_tick.png)

```
ä»·æ ¼ä¸Šå‡æ–¹å‘ (å‡ºå”® X) â†’ å¯»æ‰¾å³ä¾§åˆ»åº¦
ä»·æ ¼ä¸‹é™æ–¹å‘ (å‡ºå”® Y) â†’ å¯»æ‰¾å·¦ä¾§åˆ»åº¦
```

ç»“åˆä¸Šé¢çš„ Tick Bitmap ç»“æ„å›¾ï¼Œæˆ‘ä»¬å¯ä»¥ç†è§£ï¼š
- å½“ä»·æ ¼ä¸Šå‡æ—¶ï¼Œæˆ‘ä»¬éœ€è¦åœ¨å½“å‰åˆ»åº¦çš„å³ä¾§å¯»æ‰¾ä¸‹ä¸€ä¸ªæœ‰æµåŠ¨æ€§çš„åˆ»åº¦
- å½“ä»·æ ¼ä¸‹é™æ—¶ï¼Œæˆ‘ä»¬éœ€è¦åœ¨å½“å‰åˆ»åº¦çš„å·¦ä¾§å¯»æ‰¾ä¸‹ä¸€ä¸ªæœ‰æµåŠ¨æ€§çš„åˆ»åº¦
- è¿™ç§è®¾è®¡ç¡®ä¿äº†swapè¿‡ç¨‹ä¸­èƒ½å¤Ÿæ­£ç¡®åœ°åœ¨ä¸åŒä»·æ ¼åŒºé—´ä¹‹é—´å¯¼èˆª

### 4.3 æ–¹å‘æ€§è¯´æ˜

**é‡è¦æé†’**ï¼šåœ¨ä»£ç å®ç°ä¸­ï¼Œæ–¹å‘æ˜¯é¢ å€’çš„ï¼š
- å½“ä¹°å…¥ä»£å¸ X æ—¶ï¼Œæˆ‘ä»¬åœ¨å½“å‰åˆ»åº¦å·¦ä¾§æœç´¢å·²åˆå§‹åŒ–çš„åˆ»åº¦
- å½“å–å‡ºä»£å¸ X æ—¶ï¼Œæˆ‘ä»¬åœ¨å³ä¾§æœç´¢åˆ»åº¦

ä½†è¿™ä»…åœ¨å­—å†…éƒ¨æˆç«‹ï¼›å­—çš„æ’åºæ˜¯ä»å·¦åˆ°å³çš„ã€‚

### 4.4 è·¨å­—æœç´¢æœºåˆ¶

å½“å½“å‰å­—ä¸­æ²¡æœ‰å·²åˆå§‹åŒ–çš„åˆ»åº¦æ—¶ï¼Œæˆ‘ä»¬å°†åœ¨ä¸‹ä¸€ä¸ªå¾ªç¯ä¸­ç»§ç»­åœ¨ç›¸é‚»çš„å­—ä¸­æœç´¢ã€‚è¿™ç§è®¾è®¡é¿å…äº†éå†æ•´ä¸ªæ— é™ä½å›¾ç´¢å¼•ï¼Œæé«˜äº†æœç´¢æ•ˆç‡ã€‚

## 5. nextInitializedTickWithinOneWord å‡½æ•°å®ç°

### 5.1 å‡½æ•°ç­¾åä¸å‚æ•°

è®©æˆ‘ä»¬è¯¦ç»†åˆ†æ `nextInitializedTickWithinOneWord` å‡½æ•°çš„å®ç°ï¼š

```solidity
/**
 * @notice åœ¨å•ä¸ªå­—èŒƒå›´å†…æŸ¥æ‰¾ä¸‹ä¸€ä¸ªå·²åˆå§‹åŒ–çš„åˆ»åº¦
 * @param self ä½å›¾æ˜ å°„
 * @param tick å½“å‰åˆ»åº¦
 * @param tickSpacing åˆ»åº¦é—´è·
 * @param lte æ–¹å‘æ ‡å¿—ï¼štrueè¡¨ç¤ºå‡ºå”®Xï¼ˆå‘å³æœç´¢ï¼‰ï¼Œfalseè¡¨ç¤ºå‡ºå”®Yï¼ˆå‘å·¦æœç´¢ï¼‰
 * @return next ä¸‹ä¸€ä¸ªåˆ»åº¦ä½ç½®
 * @return initialized æ˜¯å¦æ‰¾åˆ°å·²åˆå§‹åŒ–çš„åˆ»åº¦
 */
function nextInitializedTickWithinOneWord(
    mapping(int16 => uint256) storage self,
    int24 tick,
    int24 tickSpacing,
    bool lte
) internal view returns (int24 next, bool initialized) {
    int24 compressed = tick / tickSpacing;
    // ... å®ç°é€»è¾‘
}
```

**å‚æ•°è¯´æ˜**ï¼š
- **ç¬¬ä¸€ä¸ªå‚æ•°**ï¼šä½¿è¯¥å‡½æ•°æˆä¸º `mapping(int16 => uint256)` çš„æ–¹æ³•
- **tick**ï¼šå½“å‰åˆ»åº¦ä½ç½®
- **tickSpacing**ï¼šåˆ»åº¦é—´è·ï¼Œåœ¨ Milestone 4 ä¹‹å‰å§‹ç»ˆä¸º 1
- **lte**ï¼šæ–¹å‘æ ‡å¿—
  - `true`ï¼šå‡ºå”®ä»£å¸ Xï¼Œæœç´¢å½“å‰åˆ»åº¦å³ä¾§çš„ä¸‹ä¸€ä¸ªå·²åˆå§‹åŒ–åˆ»åº¦
  - `false`ï¼šå‡ºå”®ä»£å¸ Yï¼Œæœç´¢å½“å‰åˆ»åº¦å·¦ä¾§çš„ä¸‹ä¸€ä¸ªå·²åˆå§‹åŒ–åˆ»åº¦
### 5.2 å‡ºå”®ä»£å¸ X çš„é€»è¾‘å®ç°

å½“ `lte = true` æ—¶ï¼Œæˆ‘ä»¬æ‰§è¡Œå‡ºå”®ä»£å¸ X çš„é€»è¾‘ï¼š

```solidity
if (lte) {
    (int16 wordPos, uint8 bitPos) = position(compressed);
    uint256 mask = (1 << bitPos) - 1 + (1 << bitPos);
    uint256 masked = self[wordPos] & mask;
    
    initialized = masked != 0;
    next = initialized
        ? (compressed - int24(uint24(bitPos - BitMath.mostSignificantBit(masked)))) * tickSpacing
        : (compressed - int24(uint24(bitPos))) * tickSpacing;
}
```

**ç®—æ³•æ­¥éª¤è§£æ**ï¼š

1. **è·å–ä½ç½®ä¿¡æ¯**ï¼šè®¡ç®—å½“å‰åˆ»åº¦çš„å­—ä½ç½®å’Œä½ä½ç½®
2. **åˆ›å»ºæ©ç **ï¼šåˆ¶ä½œä¸€ä¸ªæ©ç ï¼Œå…¶ä¸­å½“å‰ä½ä½ç½®å³è¾¹çš„æ‰€æœ‰ä½ï¼ˆåŒ…æ‹¬å®ƒï¼‰éƒ½æ˜¯ 1
3. **åº”ç”¨æ©ç **ï¼šå°†æ©ç åº”ç”¨åˆ°å½“å‰åˆ»åº¦çš„å­—ä¸Š
4. **åˆ¤æ–­ç»“æœ**ï¼š
   - å¦‚æœ `masked != 0`ï¼Œè¯´æ˜è‡³å°‘æœ‰ä¸€ä½è¢«è®¾ç½®ä¸º 1ï¼Œå­˜åœ¨å·²åˆå§‹åŒ–çš„åˆ»åº¦
   - å¦‚æœ `masked == 0`ï¼Œè¯´æ˜å½“å‰å­—ä¸­æ²¡æœ‰å·²åˆå§‹åŒ–çš„åˆ»åº¦

**è¿”å›å€¼é€»è¾‘**ï¼š
- å¦‚æœæ‰¾åˆ°å·²åˆå§‹åŒ–çš„åˆ»åº¦ï¼Œè¿”å›è¯¥åˆ»åº¦çš„ç´¢å¼•
- å¦‚æœæœªæ‰¾åˆ°ï¼Œè¿”å›ä¸‹ä¸€ä¸ªå­—çš„æœ€å·¦ä½ï¼Œä»¥ä¾¿åœ¨ä¸‹ä¸€ä¸ªå¾ªç¯ä¸­ç»§ç»­æœç´¢

### 5.3 å‡ºå”®ä»£å¸ Y çš„é€»è¾‘å®ç°

å½“ `lte = false` æ—¶ï¼Œæˆ‘ä»¬æ‰§è¡Œå‡ºå”®ä»£å¸ Y çš„é€»è¾‘ï¼š

```solidity
} else {
    (int16 wordPos, uint8 bitPos) = position(compressed + 1);
    uint256 mask = ~((1 << bitPos) - 1);
    uint256 masked = self[wordPos] & mask;
    
    initialized = masked != 0;
    // æº¢å‡º/ä¸‹æº¢æ˜¯å¯èƒ½çš„ï¼Œä½†é€šè¿‡é™åˆ¶ tickSpacing å’Œ tick åœ¨å¤–éƒ¨é˜²æ­¢
    next = initialized
        ? (compressed + 1 + int24(uint24((BitMath.leastSignificantBit(masked) - bitPos)))) * tickSpacing
        : (compressed + 1 + int24(uint24((type(uint8).max - bitPos)))) * tickSpacing;
}
```

**ç®—æ³•æ­¥éª¤è§£æ**ï¼š

1. **è·å–ä½ç½®ä¿¡æ¯**ï¼šè®¡ç®—ä¸‹ä¸€ä¸ªåˆ»åº¦çš„å­—ä½ç½®å’Œä½ä½ç½®
2. **åˆ›å»ºåå‘æ©ç **ï¼šåˆ¶ä½œä¸€ä¸ªä¸åŒçš„æ©ç ï¼Œå…¶ä¸­å½“å‰åˆ»åº¦ä½ä½ç½®å·¦ä¾§çš„æ‰€æœ‰ä½éƒ½æ˜¯ 1ï¼Œå³ä¾§çš„æ‰€æœ‰ä½éƒ½æ˜¯ 0
3. **åº”ç”¨æ©ç **ï¼šå°†æ©ç åº”ç”¨åˆ°å½“å‰åˆ»åº¦çš„å­—ä¸Š
4. **åˆ¤æ–­ç»“æœ**ï¼šåŒæ ·é€šè¿‡ `masked != 0` æ¥åˆ¤æ–­æ˜¯å¦å­˜åœ¨å·²åˆå§‹åŒ–çš„åˆ»åº¦

**è¿”å›å€¼é€»è¾‘**ï¼š
- å¦‚æœæ‰¾åˆ°å·²åˆå§‹åŒ–çš„åˆ»åº¦ï¼Œè¿”å›è¯¥åˆ»åº¦çš„ç´¢å¼•
- å¦‚æœæœªæ‰¾åˆ°ï¼Œè¿”å›å‰ä¸€ä¸ªå­—çš„æœ€å³ä½ï¼Œä»¥ä¾¿åœ¨ä¸‹ä¸€ä¸ªå¾ªç¯ä¸­ç»§ç»­æœç´¢

**å®‰å…¨è€ƒè™‘**ï¼š
- ä»£ç ä¸­æ³¨é‡Šæåˆ°æº¢å‡º/ä¸‹æº¢æ˜¯å¯èƒ½çš„ï¼Œä½†é€šè¿‡å¤–éƒ¨é™åˆ¶ `tickSpacing` å’Œ `tick` çš„å€¼æ¥é˜²æ­¢
## 6. å‡½æ•°ç‰¹æ€§ä¸é™åˆ¶

### 6.1 æœç´¢èŒƒå›´é™åˆ¶

`nextInitializedTickWithinOneWord` å‡½æ•°çš„ä¸€ä¸ªé‡è¦ç‰¹æ€§æ˜¯å®ƒçš„æœç´¢èŒƒå›´é™åˆ¶ï¼š

- **æœç´¢èŒƒå›´**ï¼šä»…é™äºå½“å‰åˆ»åº¦æˆ–ä¸‹ä¸€ä¸ªåˆ»åº¦çš„å­—
- **è®¾è®¡ç›®çš„**ï¼šé¿å…éå†æ•´ä¸ªæ— é™ä½å›¾ç´¢å¼•
- **æ€§èƒ½è€ƒè™‘**ï¼šé€šè¿‡é™åˆ¶æœç´¢èŒƒå›´ï¼Œç¡®ä¿å‡½æ•°æ‰§è¡Œæ•ˆç‡

### 6.2 ç®—æ³•ä¼˜åŠ¿

è¿™ç§è®¾è®¡å¸¦æ¥äº†ä»¥ä¸‹ä¼˜åŠ¿ï¼š

1. **é«˜æ•ˆæ€§**ï¼šä¸éœ€è¦éå†æ•´ä¸ªä½å›¾ç´¢å¼•
2. **å¯é¢„æµ‹æ€§**ï¼šæ‰§è¡Œæ—¶é—´æœ‰æ˜ç¡®çš„ä¸Šé™
3. **å®ç”¨æ€§**ï¼šåœ¨å®é™…åº”ç”¨ä¸­ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹éƒ½èƒ½åœ¨å•ä¸ªå­—å†…æ‰¾åˆ°ç›®æ ‡åˆ»åº¦

## 7. å®Œæ•´çš„ TickBitmap åº“å®ç°

### 7.1 åº“ç»“æ„

åŸºäºä»¥ä¸Šåˆ†æï¼Œæˆ‘ä»¬å¯ä»¥æ„å»ºå®Œæ•´çš„ TickBitmap åº“ï¼š

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

library TickBitmap {
    /// @notice è®¡ç®—åˆ»åº¦åœ¨ä½å›¾ä¸­çš„ä½ç½®
    function position(int24 tick) private pure returns (int16 wordPos, uint8 bitPos) {
        wordPos = int16(tick >> 8);
        bitPos = uint8(uint24(tick % 256));
    }

    /// @notice ç¿»è½¬æŒ‡å®šåˆ»åº¦çš„æ ‡å¿—ä½
    function flipTick(
        mapping(int16 => uint256) storage self,
        int24 tick,
        int24 tickSpacing
    ) internal {
        require(tick % tickSpacing == 0, "Tick not spaced");
        (int16 wordPos, uint8 bitPos) = position(tick / tickSpacing);
        uint256 mask = 1 << bitPos;
        self[wordPos] ^= mask;
    }

    /// @notice åœ¨å•ä¸ªå­—èŒƒå›´å†…æŸ¥æ‰¾ä¸‹ä¸€ä¸ªå·²åˆå§‹åŒ–çš„åˆ»åº¦
    function nextInitializedTickWithinOneWord(
        mapping(int16 => uint256) storage self,
        int24 tick,
        int24 tickSpacing,
        bool lte
    ) internal view returns (int24 next, bool initialized) {
        int24 compressed = tick / tickSpacing;
        
        if (lte) {
            (int16 wordPos, uint8 bitPos) = position(compressed);
            uint256 mask = (1 << bitPos) - 1 + (1 << bitPos);
            uint256 masked = self[wordPos] & mask;
            
            initialized = masked != 0;
            next = initialized
                ? (compressed - int24(uint24(bitPos - BitMath.mostSignificantBit(masked)))) * tickSpacing
                : (compressed - int24(uint24(bitPos))) * tickSpacing;
        } else {
            (int16 wordPos, uint8 bitPos) = position(compressed + 1);
            uint256 mask = ~((1 << bitPos) - 1);
            uint256 masked = self[wordPos] & mask;
            
            initialized = masked != 0;
            next = initialized
                ? (compressed + 1 + int24(uint24((BitMath.leastSignificantBit(masked) - bitPos)))) * tickSpacing
                : (compressed + 1 + int24(uint24((type(uint8).max - bitPos)))) * tickSpacing;
        }
    }
}
```

## 8. Foundry æµ‹è¯•å®ç°

### 8.1 æµ‹è¯•åˆçº¦ç»“æ„

è®©æˆ‘ä»¬ä½¿ç”¨ Foundry æµ‹è¯•æ¡†æ¶æ¥éªŒè¯ TickBitmap çš„åŠŸèƒ½ï¼š

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

import "forge-std/Test.sol";
import "../src/lib/TickBitmap.sol";

contract TickBitmapTest is Test {
    using TickBitmap for mapping(int16 => uint256);
    
    mapping(int16 => uint256) public tickBitmap;
    
    function setUp() public {
        // æµ‹è¯•åˆå§‹åŒ–
    }
    
    /// @notice æµ‹è¯•ä½ç½®è®¡ç®—å‡½æ•°
    function testPosition() public {
        // æµ‹è¯•åˆ»åº¦ 85176 çš„ä½ç½®è®¡ç®—
        int24 tick = 85176;
        (int16 wordPos, uint8 bitPos) = TickBitmap.position(tick);
        
        assertEq(wordPos, 332);
        assertEq(bitPos, 184);
    }
    
    /// @notice æµ‹è¯•æ ‡å¿—ä½ç¿»è½¬åŠŸèƒ½
    function testFlipTick() public {
        int24 tick = 85176;
        int24 tickSpacing = 1;
        
        // åˆå§‹çŠ¶æ€åº”è¯¥ä¸º 0
        (int16 wordPos, uint8 bitPos) = TickBitmap.position(tick / tickSpacing);
        uint256 initialValue = tickBitmap[wordPos];
        
        // ç¿»è½¬æ ‡å¿—ä½
        tickBitmap.flipTick(tick, tickSpacing);
        
        // éªŒè¯æ ‡å¿—ä½å·²è¢«è®¾ç½®
        uint256 afterFlip = tickBitmap[wordPos];
        assertTrue(afterFlip != initialValue);
        
        // å†æ¬¡ç¿»è½¬åº”è¯¥æ¢å¤åŸçŠ¶
        tickBitmap.flipTick(tick, tickSpacing);
        uint256 afterSecondFlip = tickBitmap[wordPos];
        assertEq(afterSecondFlip, initialValue);
    }
    
    /// @notice æµ‹è¯•æŸ¥æ‰¾ä¸‹ä¸€ä¸ªå·²åˆå§‹åŒ–åˆ»åº¦
    function testNextInitializedTickWithinOneWord() public {
        // è®¾ç½®ä¸€äº›æµ‹è¯•åˆ»åº¦
        tickBitmap.flipTick(85176, 1);
        tickBitmap.flipTick(85180, 1);
        tickBitmap.flipTick(85184, 1);
        
        // æµ‹è¯•å‘å³æœç´¢ï¼ˆå‡ºå”® Xï¼‰
        (int24 next, bool initialized) = tickBitmap.nextInitializedTickWithinOneWord(
            85170,  // å½“å‰åˆ»åº¦
            1,      // tickSpacing
            true    // lte = trueï¼Œå‘å³æœç´¢
        );
        
        assertTrue(initialized);
        assertEq(next, 85176);
        
        // æµ‹è¯•å‘å·¦æœç´¢ï¼ˆå‡ºå”® Yï¼‰
        (next, initialized) = tickBitmap.nextInitializedTickWithinOneWord(
            85190,  // å½“å‰åˆ»åº¦
            1,      // tickSpacing
            false   // lte = falseï¼Œå‘å·¦æœç´¢
        );
        
        assertTrue(initialized);
        assertEq(next, 85184);
    }
    
    /// @notice Fuzzing æµ‹è¯•
    function testFuzz_FlipTick(int24 tick) public {
        vm.assume(tick % 1 == 0);  // ç¡®ä¿ tick ç¬¦åˆé—´è·è¦æ±‚
        
        uint256 initialValue = tickBitmap[TickBitmap.position(tick).wordPos];
        
        // ç¿»è½¬ä¸¤æ¬¡åº”è¯¥æ¢å¤åŸçŠ¶
        tickBitmap.flipTick(tick, 1);
        tickBitmap.flipTick(tick, 1);
        
        uint256 finalValue = tickBitmap[TickBitmap.position(tick).wordPos];
        assertEq(finalValue, initialValue);
    }
}
```

### 8.2 æµ‹è¯•è¿è¡Œå‘½ä»¤

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
forge test --match-contract TickBitmapTest -vvv

# è¿è¡Œç‰¹å®šæµ‹è¯•
forge test --match-test testFlipTick -vvv

# ç”Ÿæˆ Gas æŠ¥å‘Š
forge test --match-contract TickBitmapTest --gas-report
```

## 9. æŠ€æœ¯è¦ç‚¹æ€»ç»“

### 9.1 æ ¸å¿ƒæ¦‚å¿µ

1. **ä½å›¾ç´¢å¼•**ï¼šä½¿ç”¨ç´§å‡‘çš„äºŒè¿›åˆ¶è¡¨ç¤ºæ¥ç´¢å¼•åˆ»åº¦çŠ¶æ€
2. **å­—åˆ†å‰²**ï¼šå°†æ— é™æ•°ç»„åˆ†å‰²ä¸º 256 ä½çš„å­—ï¼Œä¾¿äºç®¡ç†
3. **ä½ç½®è®¡ç®—**ï¼šé€šè¿‡ä½è¿ç®—å¿«é€Ÿè®¡ç®—åˆ»åº¦åœ¨å­—ä¸­çš„ä½ç½®
4. **æ ‡å¿—ç¿»è½¬**ï¼šä½¿ç”¨å¼‚æˆ–æ“ä½œé«˜æ•ˆåœ°åˆ‡æ¢åˆ»åº¦çŠ¶æ€

### 9.2 ç®—æ³•ä¼˜åŠ¿

1. **ç©ºé—´æ•ˆç‡**ï¼šæ¯ä¸ªå­—å¯ä»¥å­˜å‚¨ 256 ä¸ªåˆ»åº¦çš„çŠ¶æ€ä¿¡æ¯
2. **æ—¶é—´æ•ˆç‡**ï¼šä½è¿ç®—æ“ä½œéå¸¸å¿«é€Ÿ
3. **å¯æ‰©å±•æ€§**ï¼šæ”¯æŒæ— é™æ•°é‡çš„åˆ»åº¦ç´¢å¼•
4. **Gas ä¼˜åŒ–**ï¼šå‡å°‘äº†å­˜å‚¨è®¿é—®å’Œè®¡ç®—å¼€é”€

### 9.3 å®é™…åº”ç”¨

TickBitmap ç´¢å¼•ä¸º UniswapV3 çš„ä»¥ä¸‹åŠŸèƒ½æä¾›äº†åŸºç¡€ï¼š

- **åŠ¨æ€æµåŠ¨æ€§ç®¡ç†**ï¼šå¿«é€Ÿå®šä½æœ‰æµåŠ¨æ€§çš„ä»·æ ¼åŒºé—´
- **é«˜æ•ˆswapç®—æ³•**ï¼šåœ¨swapè¿‡ç¨‹ä¸­å¿«é€Ÿæ‰¾åˆ°ä¸‹ä¸€ä¸ªä»·æ ¼ç‚¹
- **æµåŠ¨æ€§èšåˆ**ï¼šå°†åˆ†æ•£çš„æµåŠ¨æ€§é›†ä¸­åˆ°ç‰¹å®šä»·æ ¼åŒºé—´

## åã€æ ¸å¿ƒçŸ¥è¯†ç‚¹å›é¡¾

### 10.1 æŠ€æœ¯è¦ç‚¹æ€»ç»“

1. **ä½å›¾ç´¢å¼•åŸç†**ï¼šä½¿ç”¨ç´§å‡‘çš„äºŒè¿›åˆ¶è¡¨ç¤ºæ¥ç´¢å¼•åˆ»åº¦çŠ¶æ€
2. **å­—åˆ†å‰²æœºåˆ¶**ï¼šå°†æ— é™æ•°ç»„åˆ†å‰²ä¸º 256 ä½çš„å­—ï¼Œä¾¿äºç®¡ç†
3. **ä½ç½®è®¡ç®—ç®—æ³•**ï¼šé€šè¿‡ä½è¿ç®—å¿«é€Ÿè®¡ç®—åˆ»åº¦åœ¨å­—ä¸­çš„ä½ç½®
4. **æ ‡å¿—ç¿»è½¬æœºåˆ¶**ï¼šä½¿ç”¨å¼‚æˆ–æ“ä½œé«˜æ•ˆåœ°åˆ‡æ¢åˆ»åº¦çŠ¶æ€
5. **åŠ¨æ€æŸ¥æ‰¾ç®—æ³•**ï¼šåœ¨å•ä¸ªå­—èŒƒå›´å†…æŸ¥æ‰¾ä¸‹ä¸€ä¸ªå·²åˆå§‹åŒ–çš„åˆ»åº¦

### 10.2 ç®—æ³•ä¼˜åŠ¿

1. **ç©ºé—´æ•ˆç‡**ï¼šæ¯ä¸ªå­—å¯ä»¥å­˜å‚¨ 256 ä¸ªåˆ»åº¦çš„çŠ¶æ€ä¿¡æ¯
2. **æ—¶é—´æ•ˆç‡**ï¼šä½è¿ç®—æ“ä½œéå¸¸å¿«é€Ÿ
3. **å¯æ‰©å±•æ€§**ï¼šæ”¯æŒæ— é™æ•°é‡çš„åˆ»åº¦ç´¢å¼•
4. **Gas ä¼˜åŒ–**ï¼šå‡å°‘äº†å­˜å‚¨è®¿é—®å’Œè®¡ç®—å¼€é”€

### 10.3 å®é™…åº”ç”¨

TickBitmap ç´¢å¼•ä¸º UniswapV3 çš„ä»¥ä¸‹åŠŸèƒ½æä¾›äº†åŸºç¡€ï¼š

- **åŠ¨æ€æµåŠ¨æ€§ç®¡ç†**ï¼šå¿«é€Ÿå®šä½æœ‰æµåŠ¨æ€§çš„ä»·æ ¼åŒºé—´
- **é«˜æ•ˆswapç®—æ³•**ï¼šåœ¨swapè¿‡ç¨‹ä¸­å¿«é€Ÿæ‰¾åˆ°ä¸‹ä¸€ä¸ªä»·æ ¼ç‚¹
- **æµåŠ¨æ€§èšåˆ**ï¼šå°†åˆ†æ•£çš„æµåŠ¨æ€§é›†ä¸­åˆ°ç‰¹å®šä»·æ ¼åŒºé—´

## åä¸€ã€å®è·µè¦ç‚¹æ€»ç»“

### 11.1 å…³é”®ç®—æ³•å›é¡¾

**ä½ç½®è®¡ç®—ï¼š**
```solidity
wordPos = int16(tick >> 8);  // å­—ä½ç½®
bitPos = uint8(uint24(tick % 256));  // ä½ä½ç½®
```

**æ ‡å¿—ç¿»è½¬ï¼š**
```solidity
uint256 mask = 1 << bitPos;
self[wordPos] ^= mask;  // å¼‚æˆ–æ“ä½œç¿»è½¬æ ‡å¿—ä½
```

### 11.2 æ€§èƒ½ç‰¹å¾

- **æ—¶é—´å¤æ‚åº¦**ï¼šO(1) çš„æŸ¥æ‰¾å’Œæ›´æ–°æ“ä½œ
- **ç©ºé—´å¤æ‚åº¦**ï¼šæ¯ä¸ªåˆ»åº¦ä»…å ç”¨ 1 ä½å­˜å‚¨ç©ºé—´
- **Gas æ¶ˆè€—**ï¼šç›¸æ¯”ä¼ ç»Ÿæ•°ç»„æ–¹å¼èŠ‚çœ 90% ä»¥ä¸Šçš„ Gas

### 11.3 ä¸‹ä¸€æ­¥å­¦ä¹ è®¡åˆ’

åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ å¦‚ä½•å®ç°å¹¿ä¹‰çš„æµåŠ¨æ€§é“¸é€ ï¼ˆGeneralized Mintingï¼‰ï¼Œè¿™å°†å…è®¸ç”¨æˆ·åœ¨ä»»æ„ä»·æ ¼åŒºé—´å†…æä¾›æµåŠ¨æ€§ï¼Œå¹¶åˆ©ç”¨æˆ‘ä»¬åˆšåˆšå®ç°çš„ TickBitmap ç´¢å¼•æ¥ç®¡ç†è¿™äº›æµåŠ¨æ€§ã€‚

## åäºŒã€å»¶ä¼¸æ€è€ƒ

### 12.1 æŠ€æœ¯æ€è€ƒé¢˜

1. **ä¸ºä»€ä¹ˆé€‰æ‹© 256 ä½ä½œä¸ºå­—çš„å¤§å°ï¼Ÿ**
   - è¿™ä¸ªé€‰æ‹©æœ‰ä»€ä¹ˆä¼˜åŠ¿ï¼Ÿ
   - å¦‚æœæ”¹å˜å­—å¤§å°ä¼šæœ‰ä»€ä¹ˆå½±å“ï¼Ÿ

2. **ä½å›¾ç´¢å¼•çš„å±€é™æ€§æ˜¯ä»€ä¹ˆï¼Ÿ**
   - åœ¨ä»€ä¹ˆæƒ…å†µä¸‹ä½å›¾ç´¢å¼•å¯èƒ½ä¸å¤Ÿé«˜æ•ˆï¼Ÿ
   - å¦‚ä½•ä¼˜åŒ–æç«¯æƒ…å†µä¸‹çš„æ€§èƒ½ï¼Ÿ

3. **å¦‚ä½•æ‰©å±•ä½å›¾ç´¢å¼•åŠŸèƒ½ï¼Ÿ**
   - å¯ä»¥æ·»åŠ å“ªäº›é¢å¤–çš„ç´¢å¼•ä¿¡æ¯ï¼Ÿ
   - å¦‚ä½•æ”¯æŒæ›´å¤æ‚çš„æŸ¥è¯¢æ“ä½œï¼Ÿ

### 12.2 å®è·µå»ºè®®

1. **åŠ¨æ‰‹å®è·µ**ï¼šå°è¯•å®ç°è‡ªå·±çš„ä½å›¾ç´¢å¼•ç³»ç»Ÿ
2. **æ€§èƒ½æµ‹è¯•**ï¼šå¯¹æ¯”ä½å›¾ç´¢å¼•ä¸ä¼ ç»Ÿæ•°ç»„çš„æ€§èƒ½å·®å¼‚
3. **è¾¹ç•Œæµ‹è¯•**ï¼šæµ‹è¯•æç«¯æƒ…å†µä¸‹çš„ç³»ç»Ÿè¡Œä¸º

## é¡¹ç›®ä»“åº“

æœ¬æ–‡æ˜¯ UniswapV3 æŠ€æœ¯å­¦ä¹ ç³»åˆ—çš„ä¸€éƒ¨åˆ†ï¼Œå®Œæ•´çš„ä»£ç å®ç°å’Œæ›´å¤šæŠ€æœ¯æ–‡ç« è¯·è®¿é—®ï¼š

**UniswapV3 æŠ€æœ¯å­¦ä¹ é¡¹ç›®**ï¼šhttps://github.com/RyanWeb31110/uniswapv3_tech

**ç³»åˆ—é¡¹ç›®å¯¹æ¯”å­¦ä¹ **ï¼š
- [UniswapV1 æŠ€æœ¯å­¦ä¹ ](https://github.com/RyanWeb31110/uniswapv1_tech) - ç†è§£ AMM åŸºç¡€åŸç†
- [UniswapV2 æŠ€æœ¯å­¦ä¹ ](https://github.com/RyanWeb31110/uniswapv2_tech) - æŒæ¡æ’å®šä¹˜ç§¯æ¨¡å‹
- [UniswapV3 æŠ€æœ¯å­¦ä¹ ](https://github.com/RyanWeb31110/uniswapv3_tech) - æ·±å…¥é›†ä¸­æµåŠ¨æ€§æœºåˆ¶

æ¬¢è¿å…‹éš†ä»£ç è¿›è¡Œå®è·µå­¦ä¹ ï¼Œé€šè¿‡åŠ¨æ‰‹å®ç°æ¥æ·±å…¥ç†è§£ UniswapV3 çš„æ ¸å¿ƒæŠ€æœ¯åŸç†ã€‚